# Crane

## Шаг 1. Установка

Установите [`crane`](https://github.com/google/go-containerregistry/releases) из набора инструментов Google:
1. Скачайте установочный файл (Linux_x86_64.tar.gz)
2. Распакуйте: `tar -xvf tar.gz`
3. Установите `crane`: `sudo install crane /usr/local/bin`

## Шаг 2. Запуск локального реестра

```sh
docker run -d -p 5000:5000 --restart=always --name registry registry:2
```

## Шаг 3. Публикация образа в локальный реестр

```sh
docker image tag webapp:1.0-tomcat10 localhost:5000/local/webapp:1.0-tomcat10
docker image push localhost:5000/local/webapp:1.0-tomcat10
```

## Шаг 2. Flattening образа

Flattening можно провести следующей командой:

```sh
crane flatten -t localhost:5000/local/webapp:1.0-tomcat10-flat localhost:5000/local/webapp:1.0-tomcat10
```

Сравните количество слоёв:
```sh
crane manifest localhost:5000/local/webapp:1.0-tomcat10
crane manifest localhost:5000/local/webapp:1.0-tomcat10-flat
```

Скачайте flattened-образ:
```sh
docker image pull localhost:5000/local/webapp:1.0-tomcat10-flat
```

Сравните размеры:
```sh
docker image ls | grep tomcat10
```

## Альтернатива

В качестве альтернативы можно расмотреть [docker-squash](https://github.com/goldmann/docker-squash)
