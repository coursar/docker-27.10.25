# Private Registry

## Шаг 1. Запись в /etc/hosts

В качестве имени для нашего registry выберем `registry.local`

Добавьте соответствующую запись в `/etc/hosts`:

```sh
sudoedit /etc/hosts
```

Запись:
```
192.168.56.11 registry.local
```

Удостоверьтесь, что данный адрес разрешается в указанный ip:

```sh
nslookup registry.local
```

## Шаг 2. Генерация сертификатов

План работы:

1. CA генерирует себе ключевую пару
2. CA генерирует себе сертификат открытого ключа и подписывает его своим приватным ключом
3. CA передаёт по доверенному каналу свой сертификат всем, "все" его устанавливают
4. Registry генерирует себе ключевую пару
5. Registry генерирует запрос на получение сертификата и отправляет его CA
6. CA формирует сертификат публичного ключа для Registry, после всех необходимых проверок
7. При взаимодействии Client проверяет сертификат открытого ключа Registry

Лабораторную работу нужно выполнять в контейнере Ubuntu Plucky или выше (там будет необходимая версия OpenSSL):

```sh
# запуск контейнера (с фиксированным именем хоста)
docker run -it -h registry.local -w /tls -v "$PWD"/tls:/tls ubuntu:plucky /bin/bash

# установка openssl внутрь контейнера
apt update && apt install -y openssl ca-certificates
```

**Важно**: версия должна быть 3.4+:
```sh
openssl version
```

### Шаг 2.1. Генерация ключей CA

```sh
openssl genpkey -algorithm EC -pkeyopt ec_paramgen_curve:secp384r1 -out ca.private.key -outpubkey ca.public.key
```

### Шаг 2.2. Генерация сертификата CA

```sh
openssl req -x509 -set_serial 1 -not_before 20251001000000Z -not_after 20270101000000Z -subj "/C=RU/O=StudentOrg/OU=Security/CN=ca.local" -addext "keyUsage=critical,keyCertSign" -sha384 -key ca.private.key -out ca.crt
```

Просмотр сертификата:
```sh
openssl x509 -text -in ca.crt -noout
```

### Шаг 2.3. Установка сертификата CA

**Важно**: этот шаг выполняется в контейнере!

```sh
# в контейнере
install -D ca.crt /usr/local/share/ca-certificates/ca.crt
update-ca-certificates
```

В выводе ожидается:
```
1 added, 0 removed; done.
```

### Шаг 2.4. Генерация ключей Registry

```sh
openssl genpkey -algorithm EC -pkeyopt ec_paramgen_curve:secp384r1 -out registry.private.key -outpubkey registry.public.key
```

### Шаг 2.5. Генерация запроса на сертификат Registry

```sh
openssl req -new -subj "/C=RU/O=StudentOrg/OU=Dev/CN=registry.local" -addext "subjectAltName=DNS:registry.local,IP:127.0.0.1" -sha384 -key registry.private.key -out registry.csr
```

Просмотр запроса на сертификат:
```sh
openssl req -text -in registry.csr -noout
```

### Шаг 2.6. Формирование сертификата сервера

```sh
openssl x509 -req -set_serial 2 -not_before 20251001000000Z -not_after 20260101000000Z -copy_extensions copyall -CA ca.crt -sha384 -CAkey ca.private.key -in registry.csr -out registry.crt
```

Просмотр сертификата:
```sh
openssl x509 -text -in registry.crt -noout
```

### Шаг 2.7. Взаимодействие

Для проверки воспользуемся `s_server` и `s_client` из состава OpenSSL, где:
* `s_server` будет сервером с установленным сертификатом
* `s_client` будет клиентом

В одном терминале запустите сервер:
```sh
openssl s_server -tls1_3 -key registry.private.key -cert registry.crt -accept 8443 -www -trace
```

В другом &ndash; клиент (`docker exec -it CONTAINER /bin/bash`):

```sh
openssl s_client -tls1_3 -verify_return_error -trace registry.local:8443
```

Если в результате клиент не завершился с ошибкой, значит, всё хорошо

Пример ошибки:
```
...
---
New, TLSv1.3, Cipher is TLS_AES_256_GCM_SHA384
Protocol: TLSv1.3
This TLS version forbids renegotiation.
Compression: NONE
Expansion: NONE
No ALPN negotiated
Early data was not sent
Verify return code: 20 (unable to get local issuer certificate)
---
```

### Шаг 2.8. Установка сертификата CA на хосте

```sh
# на хосте (в каталоге с файлом ca.crt)
sudo install -D ca.crt /usr/local/share/ca-certificates/ca.crt
sudo update-ca-certificates
```

В выводе ожидается:
```
1 added, 0 removed; done.
```

После этого необходимо перезапустить сервис docker:
```sh
sudo systemctl restart docker
```

Если что-то пошло не так, то можно удалить сертификат из `/usr/local/share/ca-certificates/` и запустить `update-ca-certificates -f`

В качестве альтернативы можно (но не нужно в рамках лабораторных работ) [настроить сертификат только для Docker'а](https://docs.docker.com/engine/security/certificates)

## Шаг 3. Private Registry (on host)

В качестве реестра будем использовать [CNCF Distribution](https://distribution.github.io/distribution)

Самостоятельно напишите Docker Compose файл для следующего запуска ([Docker Compose Reference](https://docs.docker.com/reference/compose-file)):

```sh
docker run \
    -p 5000:5000 \
    -v "$PWD"/tls:/tls:ro \
    -v "$PWD"/registry-storage:/var/lib/registry:rw \
    -e REGISTRY_HTTP_TLS_CERTIFICATE=/tls/registry.crt \
    -e REGISTRY_HTTP_TLS_KEY=/tls/registry.private.key \
    -e OTEL_TRACES_EXPORTER=none \
    --restart always \
    --name registry \
    registry:3.0.0
```

**Важно**: `docker-compose.yml` и каталоги `tls` и `registry-storage` размещайте вне репозитория (например, в домашнем каталоге, иначе при синхронизации репозитория хранилище образов будет утрачено)

Если ругается на то, что:
* порт 5000 уже занят
* контейнер с именем `registry` уже существует

То находите контейнер через `docker ps` и удаляете через `docker rm -f <CONTAINER>`, где флаг `-f` удалит даже работающий контейнер (**важно**: не промахнитесь и не удалите нужный!)

## Шаг 4. Публикация в Private Registry (on host)

Для публикации в registry необходимо собрать два приложения (`appv1` и `appv2`) и дать им теги:

* `registry.local:5000/library/app-boot:1.0.0` для `appv1`
* `registry.local:5000/library/app-boot:2.0.0` для `appv2`

Команда сборки (для первой версии):

```sh
docker image build -t registry.local:5000/library/app-boot:1.0.0 -f Dockerfile.slim .
```

Команда публикации (для первой версии):

```sh
docker image push registry.local:5000/library/app-boot:1.0.0
```

Аналогично для второй версии

Проверка с помощью `skopeo` существующих тегов:

```sh
skopeo list-tags docker://registry.local:5000/library/app-boot
```

Ожидается вывод:

```json
{
    "Repository": "registry.local:5000/library/app-boot",
    "Tags": [
        "1.0.0",
        "2.0.0"
    ]
}
```

