# K8S Deployment

**Важно**: если вы **не подняли** локальный registry (`registry.local:5000`), то во всех yml замените `image` на:
* `ghcr.io/coursar/docker-27.10.25/app-boot:1.0.0` для версии 1.0.0
* `ghcr.io/coursar/docker-27.10.25/app-boot:2.0.0` для версии 2.0.0

В противном случае, убедитесь, что ваш локальный реестр доступен и содержит необходимые образа:

```sh
docker container ls | grep registry

skopeo list-tags docker://registry.local:5000/library/app-boot
```

Ожидается вывод:

```json
{
    "Repository": "registry.local:5000/library/app-boot",
    "Tags": [
        "1.0.0",
        "2.0.0"
    ]
}
```

## Шаг 0. Подключение

Удостоверьтесь, что можете с помощью `kubectl` получить информацию о кластере:

```sh
kubectl cluster-info
```

## Шаг 1. Проверка ресурсов Работа

Получите список существующих ресурсов в Namespace appns:

```sh
kubectl -n appns get all
```

Ожидается следующая строка (это значит, что ресурсов нет):

```
No resources found in appns namespace.
```

Если какие-то ресурсы остались, удалите их командой:

```sh
kubectl -n appns delete RESOURCE_NAME
```

## Шаг 2. Работа с Deployment

Разверните Deployment с версией 1.0.0 образа командой:

```sh
kubectl apply -f 06_deployment_v1.yml
```

Убедитесь, что необходимые ресурсы создались:

```sh
kubectl -n appns get all
```

Удалите один pod по имени (из предыдущей команды)

```sh
kubectl -n appns delete pod NAME
```

Убедитесь, что deployment приведёт количество pod'ов к требуемому (2 инстанса):

```sh
kubectl -n appns get pods
```

Разверните Deployment с версией 2.0.0 образа командой:

```sh
kubectl apply -f 06_deployment_v2.yml
```

Посмотрите, какие Pod'ы и ReplicaSet'ы создались:

```sh
kubectl -n appns get replicasets
kubectl -n appns get pods
```

Посмотрите IP-сервиса:

```sh
kubectl -n appns get services
```

Отправьте запрос через curl и убедитесь, что версия образа обновилась до 2.0.0

```sh
curl -v http://SERVICE_IP:8080/actuator/info | jq .
```

Удалите созданные ресурсы командой:

```sh
kubectl delete -f 06_deployment_v2.yml
```

