# K8S Service

**Важно**: если вы **не подняли** локальный registry (`registry.local:5000`), то во всех yml замените `image` на:
* `ghcr.io/coursar/docker-27.10.25/app-boot:1.0.0` для версии 1.0.0
* `ghcr.io/coursar/docker-27.10.25/app-boot:2.0.0` для версии 2.0.0

В противном случае, убедитесь, что ваш локальный реестр доступен и содержит необходимые образа:

```sh
docker container ls | grep registry

skopeo list-tags docker://registry.local:5000/library/app-boot
```

Ожидается вывод:

```json
{
    "Repository": "registry.local:5000/library/app-boot",
    "Tags": [
        "1.0.0",
        "2.0.0"
    ]
}
```

## Шаг 0. Подключение

Удостоверьтесь, что можете с помощью `kubectl` получить информацию о кластере:

```sh
kubectl cluster-info
```

## Шаг 1. Проверка ресурсов

Получите список существующих ресурсов в Namespace `appns`:

```sh
kubectl -n appns get all
```

Ожидается следующая строка (это значит, что ресурсов нет):

```
No resources found in default namespace.
```

Если какие-то ресурсы остались, удалите их командой:

```sh
kubectl -n appns delete RESOURCE_NAME
```

## Шаг 2. Работа с Pod'ом и Service

Разверните Pod и Service к нему командой:

```sh
kubectl apply -f 04_service.yml
```

Убедитесь, что сервис создался:

```sh
kubectl -n appns get services
```

Ожидаемый вывод:

```
NAME            TYPE        CLUSTER-IP     EXTERNAL-IP   PORT(S)    AGE
app-service   ClusterIP   XXX.XXX.XXX.XXX   <none>        8080/TCP   13s
```

Убедитесь, что сервис доступен по IP:

```sh
curl -v http://SERVICE_IP:8080/actuator/info | jq .
```

В ответ ожидается JSON с версией:

```json
{
  "build": {
    "artifact": "boot-web-maven",
    "name": "web",
    "time": "...",
    "version": "1.0.0",
    "group": "org.example"
  },
  ...
}
```

Получите значения переменных окружения:

```sh
curl -v http://SERVICE_IP:8080/actuator/env | jq .
```

Убедитесь, что значения "скрыты":

```
"value": "******"
```

Удалите созданные ресурсы командой:

```sh
kubectl delete -f 04_service.yml
```

Измените описание в yaml-файле Pod'а так, чтобы выставлять переменную окружения (она будет отвечать за отображение значений):

```
MANAGEMENT_ENDPOINT_ENV_SHOW-VALUES=ALWAYS
```

Для этого воспользуйтесь `kubectl explain pod.spec.containers.env` или примером из [официальной документации](https://kubernetes.io/docs/tasks/inject-data-application/define-environment-variable-container)


Попробуйте применить изменения через:

```sh
kubectl apply -f 04_service.yml
```

Прочитайте ошибку, подумайте, почему переменные окружения не удаётся изменять "на лету"

Удалите под и создайте заново

Проверьте, что при запросах возвращаются значения `env`:

```sh
curl -v http://SERVICE_IP:8080/actuator/env | jq .
```

Удалите созданные ресурсы
