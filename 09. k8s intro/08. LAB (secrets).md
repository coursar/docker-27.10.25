# K8S Secrets

**Важно**: в данной лабораторной работе необходимо поднять локальный реестр, либо пользоваться сторонним

## Шаг 0. Сборка образа и запуск "Managed DB"

Проект расположен по в каталоге `legacy` (опционально можете отсмотреть `Dockerfile`, `compose.yml` и выделить недостатки)

Поднимите его с помощью docker compose:
```sh
docker compose up
```

Убедитесь, что на запрос:
```sh
curl http://localhost:8080/api/getUsers
```

Вам возвращается JSON вида:
```json
[{"id":1,"username":"admin"}]
```

Завершите работу docker compose

После этого соберите и опубликуйте образ под именем registry.local:5000/library/legacy-app:1.0.0 в локальном реестре (чтобы до него смог добраться K8s)

Запустите "Managed DB" (будем считать, что это сервис, развёрнутый вне K8s):
```sh
docker compose -f compose-db.yml up
```

Оставьте сервис работающим

## Шаг 1. Создание Secrets

Используя официальную документацию или `kubectl explain` создайте ресурс `Secret`, в котором укажите ключи для будущих переменных окружения (это считается не особо безопасным, поэтому: вы научитесь это делать, а мы укажем, что это не особо безопасно)

```yml
DB_HOST: db.local
DB_PORT: 5432
DB_NAME: db
DB_USER: app
DB_PASS: pass
```

Напомним, что данные по умолчанию надо писать в формате key: base64(value):
```sh
echo -n 'db.local' | base64
```

Но можно использовать и `stringData` (вместо `data`)

**Важно**: не забудьте добавить в `hostAliases` запись о `db.local`

## Шаг 2. Использование Secrets

Самостоятельно напишите yaml для Deployment и Service, который бы разворачивал registry.local:5000/library/legacy-app:1.0.0

Для маппинга Secrets в переменные окружения используйте следующий snippet (CAPS_WORDS нужно заменить на ваши значения):

```yml
envFrom:
- secretRef:
    name: SECRET_NAME
env:
- name: CATALINA_OPTS
  value: -DJDBC_DATABASE_URL="jdbc:postgresql://$(DB_HOST):$(DB_PORT)/$(DB_NAME)?user=$(DB_USER)&password=$(DB_PASS)"
```

Разверните всё приложение и протестируйте соответствующим запросом через сервис:
```sh
curl -v http://SERVICE_IP:8080/api/getUsers
```

Удалите созданные ресурсы
